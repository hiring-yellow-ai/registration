<!DOCTYPE html>
<html>
<head>
  <title>My Static Google App</title>
  <meta charset="utf-8" />
  <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
  <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>
</head>
<body>

  <h1>Connect to Google</h1>
  <button id="authBtn" onclick="handleAuthClick()" disabled>Authorize & Get Data</button>
  <button id="signoutBtn" onclick="handleSignoutClick()" disabled>Sign Out</button>

  <pre id="content" style="white-space: pre-wrap;"></pre>

  <script>
    // YOUR CLIENT_ID AND API_KEY
    const CLIENT_ID = '590439081250-9t6su7ram9pg0jiasdhgju1fghmqe530.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyAoIJyeKPExu99g57UcCCOQj4VvEwjDX-A'; // Only for unauthenticated access or general API usage
    
    // Scopes requested for user data and APIs
    const SCOPES = 'https://www.googleapis.com/auth/drive.metadata.readonly https://www.googleapis.com/auth/gmail.readonly profile email'; 
    // Added 'profile' and 'email' scopes to fetch user info

    let tokenClient;
    let gapiClientReady = false; // Flag for gapi.client and loaded APIs
    let gisInited = false;       // Flag for Google Identity Services initialization

    // Called when the 'gapi.js' script is loaded
    function gapiLoaded() {
      gapi.load('client', async () => {
        try {
          await gapi.client.init({
            apiKey: API_KEY, // Used for identifying your project. For authenticated calls, OAuth token takes precedence.
            // discoveryDocs: [ // No longer needed if using gapi.client.load() for specific APIs
            //   "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
            //   "https://gmail.googleapis.com/$discovery/rest?version=v1"
            // ],
          });

          // Load specific APIs after gapi.client.init
          // This ensures the API definitions (drive, gmail) are available
          await gapi.client.load('drive', 'v3');
          await gapi.client.load('gmail', 'v1');
          console.log("Google Drive and Gmail APIs loaded successfully.");
          gapiClientReady = true; // Mark gapi client and APIs as ready
          maybeEnableButtons();
        } catch (error) {
          console.error("Error initializing Google APIs or loading API definitions:", error);
          document.getElementById('content').innerText = "Error initializing Google APIs. Check console for details.";
        }
      });
    }

    // Called when the 'gsi/client' script is loaded
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // Callback defined in handleAuthClick
      });
      gisInited = true; // Mark GIS as initialized
      maybeEnableButtons();
    }

    // Enables buttons only when both GAPI client (with APIs) and GIS are ready
    function maybeEnableButtons() {
      if (gapiClientReady && gisInited) {
        document.getElementById('authBtn').disabled = false;
        document.getElementById('signoutBtn').disabled = false;
        console.log("Authorization and Sign Out buttons enabled.");
      }
    }

    // Handles the authorization flow
    function handleAuthClick() {
      // Define the callback for the token client when the user interacts
      tokenClient.callback = async (resp) => {
        if (resp.error) {
          console.error("Authentication error:", resp);
          document.getElementById('content').innerText = "Authentication failed. See console for details.";
          return; // Stop execution on error
        }
        console.log("Access token obtained.");
        document.getElementById('content').innerText = 'Authenticated successfully!\n'; // Clear previous content and show success

        // Fetch user info and then list files
        await getUserInfo();
        await listFiles();
        // await listEmails(); // Uncomment when ready to fetch emails
      };

      // Check if there's an existing token
      if (gapi.client.getToken() === null) {
        // If no token, request consent from the user
        tokenClient.requestAccessToken({prompt: 'consent'});
      } else {
        // If a token exists, try to get a new one silently (e.g., refresh)
        tokenClient.requestAccessToken({prompt: ''});
      }
    }

    // Handles user sign-out
    function handleSignoutClick() {
      const token = gapi.client.getToken();
      if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token); // Revoke the token
        gapi.client.setToken(''); // Clear the token from gapi.client
        document.getElementById('content').innerText = 'Signed out.';
        console.log("User signed out.");
      }
    }

    // Fetches user profile information
    async function getUserInfo() {
      if (!gapiClientReady) {
        console.error('Google APIs not ready to fetch user info.');
        document.getElementById('content').innerText += '\nGoogle APIs not ready to fetch user info.';
        return;
      }
      try {
        const response = await gapi.client.oauth2.userinfo.get(); // Using the oauth2 API for userinfo
        const user = response.result;
        console.log('User Info:', user);
        document.getElementById('content').innerText += `\nWelcome, ${user.name} (${user.email})\n`;
      } catch (err) {
        console.error('Error fetching user info:', err);
        document.getElementById('content').innerText += '\nError fetching user info: ' + (err.message || JSON.stringify(err));
      }
    }

    // Lists files from Google Drive
    async function listFiles() {
      if (!gapiClientReady) {
        console.error('Google APIs not ready to list Drive files.');
        document.getElementById('content').innerText += '\nGoogle APIs not ready to list Drive files.';
        return;
      }
      try {
        const response = await gapi.client.drive.files.list({
          'pageSize': 10,
          'fields': 'files(id, name)',
        });
        const files = response.result.files;
        if (!files || files.length == 0) {
          document.getElementById('content').innerText += 'No Drive files found.';
          return;
        }
        const output = files.reduce(
          (str, file) => `${str}${file.name} (${file.id})\n`,
          '\nDrive Files:\n');
        document.getElementById('content').innerText += output;
        console.log("Drive files listed successfully.");
      } catch (err) {
        console.error('Error listing files:', err);
        document.getElementById('content').innerText += '\nError listing files: ' + (err.message || JSON.stringify(err));
      }
    }

    // Placeholder for listing emails (requires Gmail API to be loaded and 'gmail.readonly' scope)
    // async function listEmails() {
    //   if (!gapiClientReady) {
    //     console.error('Google APIs not ready to list Gmail messages.');
    //     document.getElementById('content').innerText += '\nGoogle APIs not ready to list Gmail messages.';
    //     return;
    //   }
    //   try {
    //     const response = await gapi.client.gmail.users.messages.list({
    //       'userId': 'me',
    //       'maxResults': 10,
    //     });
    //     const messages = response.result.messages;
    //     if (!messages || messages.length === 0) {
    //       document.getElementById('content').innerText += '\nNo Gmail messages found.';
    //       return;
    //     }
    //     let output = '\nGmail Messages:\n';
    //     for (const message of messages) {
    //       output += `Message ID: ${message.id}\n`;
    //     }
    //     document.getElementById('content').innerText += output;
    //     console.log("Gmail messages listed successfully.");
    //   } catch (err) {
    //     console.error('Error listing emails:', err);
    //     document.getElementById('content').innerText += '\nError listing emails: ' + (err.message || JSON.stringify(err));
    //   }
    // }

  </script>
</body>
</html>
